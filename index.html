<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Infinity Scroll Videos</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #000;
    }

    #video-container {
      width: 100%;
      height: 100%;
      position: relative;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      scroll-snap-type: y mandatory;
      scroll-behavior: smooth; /* Smooth scrolling */
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }

    #video-container::-webkit-scrollbar {
      display: none;  /* Safari and Chrome */
    }

    .video-item {
      width: 100%;
      height: 100%;
      flex-shrink: 0;
      scroll-snap-align: start;
      position: relative;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <div id="video-container"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
  <script>
    const videos = [
      { id: 0, src: 'vid/A0.mp4' },
      { id: 1, src: 'vid/A1.mp4' },
      { id: 2, src: 'vid/A2.mp4' },
      { id: 3, src: 'vid/A3.mp4' },
      { id: 4, src: 'vid/A4.mp4' },
      { id: 5, src: 'vid/A5.mp4' },
      { id: 6, src: 'vid/A6.mp4' },
      { id: 7, src: 'vid/A7.mp4' },
      { id: 8, src: 'vid/A8.mp4' },
      { id: 9, src: 'vid/A9.mp4' },
    ];

    let currentVideoIndex = 0;
    let watchedVideos = [];
    let recentWatched = [];
    let loadedVideos = [];

    const videoContainer = document.getElementById('video-container');

    function loadVideo(video, index) {
      const videoItem = document.createElement('div');
      videoItem.className = 'video-item';
      videoItem.dataset.index = video.id;

      const videoElement = document.createElement('video');
      videoElement.muted = true;
      videoElement.autoplay = true;
      videoElement.playsInline = true;
      videoElement.loop = true; // 필요시 비디오 반복
      videoElement.src = video.src;

      videoItem.appendChild(videoElement);
      videoContainer.appendChild(videoItem);
    }

    function getRandomVideo() {
      let availableVideos = videos.filter(v => !watchedVideos.includes(v.id));
      if (availableVideos.length === 0) {
        availableVideos = videos.filter(v => !recentWatched.includes(v.id));
      }
      let randomVideo = availableVideos[Math.floor(Math.random() * availableVideos.length)];
      return randomVideo;
    }

    function reportVideoWatched(video) {
      console.log(`Video ID ${video.id} watched`);
    }

    function setupSwipeHandler() {
      const hammer = new Hammer(videoContainer);
      hammer.get('swipe').set({ direction: Hammer.DIRECTION_VERTICAL });

      hammer.on('swipeup', () => {
        currentVideoIndex++;
        const currentVideo = updateVideos();
        const currentVideoItem = document.querySelector(`.video-item[data-index="${currentVideo.id}"]`);
        currentVideoItem.scrollIntoView({ behavior: 'smooth' });
        reportVideoWatched(currentVideo);
        playCurrentVideo();
      });

      hammer.on('swipedown', () => {
        if (currentVideoIndex > 0) {
          currentVideoIndex--;
          const currentVideo = updateVideos();
          const currentVideoItem = document.querySelector(`.video-item[data-index="${currentVideo.id}"]`);
          currentVideoItem.scrollIntoView({ behavior: 'smooth' });
          reportVideoWatched(currentVideo);
          playCurrentVideo();
        }
      });
    }

    function playCurrentVideo() {
      const videoItems = document.querySelectorAll('.video-item');
      videoItems.forEach((item, index) => {
        const video = item.querySelector('video');
        if (index === currentVideoIndex) {
          video.play();
        } else {
          video.pause();
        }
      });
    }

    function updateVideos() {
      const videoItems = document.querySelectorAll('.video-item');
      if (videoItems.length > 3) {
        videoContainer.removeChild(videoItems[0]);
      }

      const newVideo = getRandomVideo();
      if (!watchedVideos.includes(newVideo.id)) {
        watchedVideos.push(newVideo.id);
      }
      recentWatched.push(newVideo.id);
      if (recentWatched.length > 5) {
        recentWatched.shift();
      }
      loadVideo(newVideo, currentVideoIndex);

      return newVideo;
    }

    document.addEventListener('DOMContentLoaded', () => {
      for (let i = 0; i < 3; i++) {
        const video = getRandomVideo();
        loadedVideos.push(video);
        loadVideo(video, i);
      }
      setupSwipeHandler();
      playCurrentVideo();
    });
  </script>
</body>
</html>
